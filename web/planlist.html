<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Plan List</title>
    <base href="${context}${path}/">
    <link href="${context}/favicon.ico" rel="shortcut icon">
    <link href="${context}/reset.css" rel="stylesheet" type="text/css">
    <link href="${context}/style.css" rel="stylesheet" type="text/css">
    <script src="${context}/util.js" type="text/javascript"></script>
    <script src="${context}/http.js" type="text/javascript"></script>
    <script src="${context}/locate.js" type="text/javascript"></script>
    <script src="${context}/planlist.js" type="text/javascript"></script>
    <script src="${context}/app.js" type="text/javascript"></script>
</head>
<body onclick="planSave(event)" onkeydown="bodyKeyDown(event)">


<style type="text/css">
    .plannode-button  {
        background-image: url('${context}/buttons.png');
    }
</style>


<div id="header">
    <span id="username">${user.name}</span>
    <input type="button" value="logout" onclick="document.location.href='${context}/?logout';"/>
</div>

<div id="content">
    <$ if (error) { $>
        <span class="error">${error}</span><br>
    <$ } $>

    <$ if (header) { $>
        <h1>${header}</h1>
    <$ } $>

    <div id="plan" ondblclick="planEdit(event)" onclick="event.cancelBubble=true;">${planlist}</div>
    <input type="button" id="planEditButton" value="edit" onclick="planEdit(event)"><br>

    <div id="childs">
        <$ if (childs) for (var i=0; i< childs.length; i++) { $>
            <div>
                <a class="plannode" href="${childs[i].name}">${childs[i].title}</a>
                <span class="plannode-button edit" onclick="editChildPlan(this)">&nbsp;</span>
                <span class="plannode-button delete" onclick="deleteChildPlan(this)">&nbsp;</span>
            </div>
        <$ } $>
        <span class="plannode-button add" onclick="addChildPlan(this)" style="margin-top: 8px">&nbsp;</span>
    </div>
    <$ if (parent) { $>
        <a class="plannode" href="${context+path.substring(0, path.lastIndexOf('/'))}">${parent.title}</a><br>
    <$ } $>
</div>

<div id="ajaxMessage" class="error"></div>
<div>&nbsp;<!--spacer--></div>


<script type="text/javascript">
    // убирает параметры запроса браузера для этой страницы
    function removeLocationParameters()
    {
        var url = document.location.href;
        var i = url.indexOf('?');
        if (i!==-1 && !!(window.history && history.pushState))  history.pushState(null, null, url.substring(0, i));
    }
    window.onload = function ()  {
        //removeLocationParameters();
        history.pushState(null, null, "${context}${path}");
        //
        var element = document.getElementById("plan");
        if (element)  {
            element.plantext = element.innerHTML;
            planlist.process(element, true);
            element.className = "make_plan";
        }
    };

    function bodyKeyDown(event)  {
        // по Ctrl+Enter переключение режима (сохранение или редактирование плана в зависимости от текущего режима)
        if (event.ctrlKey && event.keyCode==13)  {
            var element = getElement("plan");
            if (isPlanViewMode(element))  planEdit(event);
            else if (isPlanEditMode(element))  planSave(event);
        }
        // по Ctrl+S или Esc сохранение
        else if (event.ctrlKey && event.keyCode=='S'.charCodeAt(0) || event.keyCode==27)  {
            planSave(event);
        }
        // по Ctrl+E редактирование
        else if (event.ctrlKey && event.keyCode=='E'.charCodeAt(0))  {
            planEdit(event);
        }
    }

    function isPlanViewMode(element)  {
        return element && !(element.children[0] && element.children[0].tagName=="TEXTAREA");
    }
    function isPlanEditMode(element)  {
        return element && element.children[0] && element.children[0].tagName=="TEXTAREA" && !ajaxAction.executing[planSave.action];
    }

    function planEdit(event)  {
        var element = getElement("plan");
        if (isPlanViewMode(element))  {
            console.log("planEdit");
            element.innerHTML = "<textarea>"+escapeHTML(element.plantext)+"</textarea>";
            getElement("planEditButton").value = "save";
            getElement("planEditButton").onclick = planSave;
            //    прекратить дальнешую обработку события и стандартные действия
            event.stopPropagation();
            event.preventDefault();
        }
    }

    function planSave(event)  {
        var element = getElement("plan");
        if (isPlanEditMode(element))
        {
            console.log("planSave");
            //    если текст изменился, то запрос на сохранение плана
            var plantext = element.children[0].value;
            if (element.plantext != plantext)  {
                element.plantext = plantext;
                planSave.action = ajaxAction("?action=saveplan", plantext, "saved", displayPlan);
            }
            //    иначе, просто отобразить
            else  displayPlan();
            //    прекратить дальнешую обработку события и стандартные действия
            event.stopPropagation();  // нужно, так как стоит onclick на весь body
            event.preventDefault();
        }

        // отображает план
        function displayPlan()  {
            element.innerHTML = planlist.processText(plantext, true);
            getElement("planEditButton").value = "edit";
            getElement("planEditButton").onclick = planEdit;
        }
    }

    function addChildPlan(element)
    {
        var title = prompt("Enter plan title");
        if (title)  var name = prompt("Enter short system name");
        if (name)  ajaxAction("?action=addplan&name="+encodeURIComponent(name)+"&title="+encodeURIComponent(title), "", "added", function () {
            var div = document.createElement("DIV");
            div.innerHTML = "<a class='plannode' href='"+name+"'>"+title+"</a> " +
                            "<span class='plannode-button edit' onclick='editChildPlan(this)'>&nbsp;</span>" +
                            "<span class='plannode-button delete' onclick='deleteChildPlan(this)'>&nbsp;</span>";
            insertBefore(div, element);
        });
    }

    function deleteChildPlan(element)
    {
        element = element.parentNode;  //get total row
        var name = element.children[0].getAttribute("href");
        ajaxAction(encodeURIComponent(name)+"?action=deleteplan", "", "deleted", function () {
            removeChild(element);
        });
    }

    function editChildPlan(element)
    {
        element = element.parentNode;  //get total row
        var oldName = element.children[0].getAttribute("href");  // get old child name
        var oldTitle = element.children[0].innerHTML;  // TODO unescapeHTML
        //    enter title and name
        var title = prompt("Enter plan title", oldTitle);
        if (title)  var name = prompt("Enter short system name", oldName);
        //    execute ajax
        if (name)  ajaxAction(encodeURIComponent(oldName)+"?action=editplan&name="+encodeURIComponent(name)+"&title="+encodeURIComponent(title), "", "added", function () {
            element.children[0].setAttribute("href", name);
            element.children[0].innerHTML = title;
        });
    }
</script>


</body>
</html>