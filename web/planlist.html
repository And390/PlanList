<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Plan List</title>
    <base href="${app}${path}/">
    <link href="${app}/favicon.ico" rel="shortcut icon">
    <link href="${app}/reset.css" rel="stylesheet" type="text/css">
    <link href="${app}/style.css" rel="stylesheet" type="text/css">
    <script src="${app}/util.js" type="text/javascript"></script>
    <script src="${app}/http.js" type="text/javascript"></script>
    <script src="${app}/locate.js" type="text/javascript"></script>
    <script src="${app}/planlist.js" type="text/javascript"></script>
    <script src="${app}/app.js" type="text/javascript"></script>
</head>
<body onclick="planSave(event)" onkeydown="bodyKeyDown(event)">


<style type="text/css">
    .plannode-button  {
        background-image: url('${app}/buttons.png');
    }
</style>


<div id="header">
    <span id="username">${user.name}</span>
    <input type="button" value="logout" onclick="document.location.href='${app}/?logout';"/>
</div>

<div id="content">
    <$ if (error) { $>
        <span class="error">${error}</span><br>
    <$ } $>

    <$ if (header) { $>
        <h1>${header}</h1>
        <$/*<!--TODO если этому h1 прописать абсолютную позицию или добавить display: inline-block, то он перестанет уезжать после makeEditable-->*/$>
    <$ } $>

    <div id="plan" onclick="event.cancelBubble=true; planEdit(event)">${planlist}</div>
    <input type="button" id="planEditButton" value="edit" onclick="planEdit(event)"><br>

    <div id="childs">
        <$ if (childs) for (var i=0; i< childs.length; i++) { $>
            <div>
                <a class="plannode" href="${childs[i].name}">${childs[i].title}</a>
                <span class="plannode-button edit" onclick="editChildPlan(this)">&nbsp;</span>
                <span class="plannode-button delete" onclick="deleteChildPlan(this)">&nbsp;</span>
            </div>
        <$ } $>
        <span class="plannode-button add" onclick="addChildPlan(this)" style="margin-top: 8px">&nbsp;</span>
    </div>
    <$ if (parent) { $>
        <a class="plannode" href="${context+path.substring(0, path.lastIndexOf('/'))}">${parent.title}</a><br>
    <$ } $>
</div>

<div id="ajaxMessage" class="error"></div>
<div>&nbsp;<!--spacer--></div>


<script type="text/javascript">
    function createPlanlistParser(element)
    {
        var parser = new planlist.Parser (element, true);
        parser.addTextSuper = parser.addText;
        parser.addText = function(source, start, end)  {
            var span = this.addTextSuper(source, start, end);
            makeEditable(span, true,
                function (text) {
                    var result = [ source.substring(0, span.s) ];
                    //    скопировать все выравнивающие пробелы из исходного текста для всех имеющиихся строк
                    text = text.trim();
                    var s0=span.s, s1=-1;
                    for (var i=0, si=span.s, se=span.e;;)  {
                        //  найти следующую строку в полученном тексте
                        var i0 = i;
                        i = text.indexOf('\n', i) + 1;  if (i===0)  break;
                        //  найти следующую строку в исходном тексте
                        si = source.indexOf('\n', si) + 1;  if (si===0 || si>se)  break;
                        //  посчитать количество выравнивающих пробелов
                        s0 = si;
                        while (si<se && source.charCodeAt(si)<=32 && source.charCodeAt(si)!==10)  si++;
                        s1 = si;
                        //  вставить предыдущую целевую строку, затем выравнивающие пробелы от новой строки
                        result.push(text.substring(i0, i), source.substring(s0, s1));
                    }
                    //    добавить выравнивающие пробелы для новых строк, основываясь на последней строке
                    while (i!==0)  {
                        //  если строка исходного текста была только одна, то надо посчитать количество выравнивающих пробелов
                        var spaces;
                        if (s1===-1)  {
                            s1 = source.lastIndexOf('\n', s0-1) + 1;
                            //  и заменить все на пробелы, так как теперь они могут встретиться
                            spaces = source.substring(s0, s1).replace(/./g, ' ');
                        }
                        else  spaces = source.substring(s0, s1);
                        //  вставить предыдущую целевую строку, затем выравнивающие пробелы
                        result.push(text.substring(i0, i), spaces);
                        //  найти следующую строку в целевом тексте
                        i0 = i;
                        i = text.indexOf('\n', i) + 1;
                    }
                    //    вставить последнюю строку целевого текста
                    result.push(text.substring(i0));
                    //    и оставшуюся часть исходного текста
                    result.push(source.substring(span.e));
                    //    submit text
                    var plantext = result.join('');
                    console.log(plantext);
                    element.plantext = plantext;
                    planSave.action = ajaxAction("?action=saveplan", plantext, "saved", function() {});
                },
                function (text)  {  element.itemEditing = true;  },
                function (text)  {  element.itemEditing = false;  }
            );
        };
        return parser;
    }
    function planlistProcess(element, text)
    {
        element.innerHTML = "";
        planlist.parse(text, createPlanlistParser(element));
        element.style.whiteSpace = 'pre-wrap';
    }

    window.onload = function ()  {
        replaceAddress("${app}${path}");
        //    преобразовать исходный текст плана в html
        var element = document.getElementById("plan");
        if (element)  {
            element.plantext = element.innerHTML;
            planlistProcess(element, element.plantext);
        }
        //    редактирование заголовка
        element = document.getElementById("content").getElementsByTagName("h1")[0];
        if (element)  {
            makeEditable(element, false, function(text) {
                ajaxAction("?action=editplan&title="+encodeURIComponent(text), "", "saved", function() {});
            })
        }
    };

    // убирает параметры запроса браузера для этой страницы
    function removeLocationParameters()
    {
        var url = document.location.href;
        var i = url.indexOf('?');
        if (i!==-1)  replaceAddress(url.substring(0, i))
    }

    function bodyKeyDown(event)  {
        // по Ctrl+Enter переключение режима (сохранение или редактирование плана в зависимости от текущего режима)
        if (event.ctrlKey && event.keyCode==13)  {
            var element = getElement("plan");
            if (isPlanViewMode(element))  planEdit(event);
            else if (isPlanEditMode(element))  planSave(event);
        }
        // по Ctrl+S или Esc сохранение
        else if (event.ctrlKey && event.keyCode=='S'.charCodeAt(0) || event.keyCode==27)  {
            planSave(event);
        }
        // по Ctrl+E редактирование
        else if (event.ctrlKey && event.keyCode=='E'.charCodeAt(0))  {
            planEdit(event);
        }
    }

    function isPlanViewMode(element)  {
        return element && !element.itemEditing && !(element.children[0] && element.children[0].tagName=="TEXTAREA");
    }
    function isPlanEditMode(element)  {
        return element && !element.itemEditing && element.children[0] && element.children[0].tagName=="TEXTAREA" && !ajaxAction.executing[planSave.action];
    }

    function planEdit(event)  {
        var element = getElement("plan");
        if (isPlanViewMode(element))  {
            console.log("edit");
            element.innerHTML = "<textarea>"+escapeHTML(element.plantext)+"</textarea>";
            getElement("planEditButton").value = "save";
            getElement("planEditButton").onclick = planSave;
            element.children[0].focus();
            //    прекратить дальнешую обработку события и стандартные действия
            event.stopPropagation();
            event.preventDefault();
        }
    }

    function planSave(event)  {
        var element = getElement("plan");
        if (isPlanEditMode(element))
        {
            console.log("save");
            //    если текст изменился, то запрос на сохранение плана
            var plantext = element.children[0].value;
            if (element.plantext != plantext)  {
                element.plantext = plantext;
                planSave.action = ajaxAction("?action=saveplan", plantext, "saved", displayPlan);
            }
            //    иначе, просто отобразить
            else  displayPlan();
            //    прекратить дальнешую обработку события и стандартные действия
            event.stopPropagation();  // нужно, так как стоит onclick на весь body
            event.preventDefault();
        }

        // отображает план
        function displayPlan()  {
            element.innerHTML = "";
            planlistProcess(element, plantext);
            getElement("planEditButton").value = "edit";
            getElement("planEditButton").onclick = planEdit;
        }
    }

    function addChildPlan(element)
    {
        var title = prompt("Enter plan title");
        if (title)  var name = prompt("Enter short system name");
        if (name)  ajaxAction("?action=addplan&name="+encodeURIComponent(name)+"&title="+encodeURIComponent(title), "", "added", function () {
            var div = document.createElement("DIV");
            div.innerHTML = "<a class='plannode' href='"+name+"'>"+title+"</a> " +
                            "<span class='plannode-button edit' onclick='editChildPlan(this)'>&nbsp;</span>" +
                            "<span class='plannode-button delete' onclick='deleteChildPlan(this)'>&nbsp;</span>";
            insertBefore(div, element);
        });
    }

    function deleteChildPlan(element)
    {
        element = element.parentNode;  //get total row
        var name = element.children[0].getAttribute("href");
        ajaxAction(encodeURIComponent(name)+"?action=deleteplan", "", "deleted", function () {
            removeChild(element);
        });
    }

    function editChildPlan(element)
    {
        element = element.parentNode;  //get total row
        var oldName = element.children[0].getAttribute("href");  // get old child name
        var oldTitle = element.children[0].innerHTML;  // TODO unescapeHTML
        //    enter title and name
        var title = prompt("Enter plan title", oldTitle);
        if (title)  var name = prompt("Enter short system name", oldName);
        //    execute ajax
        if (name)  ajaxAction(encodeURIComponent(oldName)+"?action=editplan&name="+encodeURIComponent(name)+"&title="+encodeURIComponent(title), "", "added", function () {
            element.children[0].setAttribute("href", name);
            element.children[0].innerHTML = title;
        });
    }
</script>


</body>
</html>